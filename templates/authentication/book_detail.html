{% extends 'base_generic.html' %}

{% block custom_css %}
<style>
    .img-fluid{
        max-width: 100%;
        height: 320px;
        margin-top: 10px;
        margin-right: 10px;
        margin-bottom: 10px;
        margin-left: 10px;
    }
    .centered-div {
    width: 50%;  
    height: 50%; 
    }
    .book-detail-container {
        background-color: #f8f8f8;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        max-width: 1100px; /* Maximum width */
    }

    .extras-container {
    background-color: #f8f8f8;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .section-comment-container{
        background-color: #f8f8f8;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .rating-container{
        background-color: #ffffff;
        padding: 10px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .book-details h1, .book-details h3 {
        margin-bottom: 20px;
        
    }

    .book-details{
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        width: 100%; /* Full width of the parent container */
        max-width: 800px; /* Maximum width */
        margin: auto; /* Center align if the parent container is wider */
    }
    

    .additional-info span {
        display: block;
        margin-bottom: 10px;
        color: #777;
    }

    .book-cover {
        border: 5px solid #ddd;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 5px;
    }

    .book-description {
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        width: 100%; /* Full width of the parent container */
        max-width: 1000px; /* Maximum width */
        margin: auto; /* Center align if the parent container is wider */
        margin-top: 10px;
    }

    .find-book {
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        width: 100%; /* Full width of the parent container */
        max-width: 1000px; /* Maximum width */
        margin: auto; /* Center align if the parent container is wider */
        margin-top: 10px;
    }

    .read-more-link {
        display: block;
        color: #007BFF;
        text-decoration: none;
        margin-top: 15px;
    }

    .book-additional-content h5 {
        margin-bottom: 15px;
    }
    .comment-container {
        background-color: #fff;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 10px;
    }

    .comment-container strong {
        color: #007bff;
    }

    .comment-container small {
        display: block;
        color: #777;
        margin-top: 10px;
    }

    .comment-form {
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        margin-top: 20px;
    }

    .comment-form textarea {
        width: 100%;
        border-radius: 4px;
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 10px;
    }

    .comment-form button {
        background-color: #28a745;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    .book-rating-form button{
        background-color: #28a745;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .comment-form button:hover {
        background-color: #218838;
    }
    /* New styles for unified rating and comments container */
    .rating-comments-container {
        background-color: #f8f8f8;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        margin-top: 20px;
        width: 100%; /* Full width of the parent container */
        max-width: 1100px; /* Maximum width */
        margin: auto; /* Center align if the parent container is wider */
    }

    /* Adjustments to existing classes for consistency */
    .book-rating-form, .comment-container, .comment-form {
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        margin-bottom: 20px;
    }

    /* Adjustments for the "You may also like" section */
    .recommended-books-container {
        background-color: #f8f8f8;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        width: 100%; /* Full width of the parent container */
        max-width: 1100px; /* Maximum width */
        margin: auto; /* Center align if the parent container is wider */
        margin-top: 20px;
    }
    
   
</style>
{% endblock %}


{% block content %}
<div class="container book-detail-container">
    <div class="row mt-5">
        <div class="col-md-3">
            <div class="book-cover">
                <img src="{{ book.coverImg|default_if_none:'#' }}" alt="Cover image of {{ book.title }}" class="img-fluid">
            </div>
            {% if user.is_authenticated %}
                {% if is_bookmarked %}
                    <a href="{% url 'remove_bookmark' book.id %}?next={{ request.path }}" style="text-decoration: none; color: white; background-color: #dc3545; padding: 10px 15px; border-radius: 5px; display: inline-block; margin-top: 10px;">Unbookmark this Book</a>
                {% else %}
                    <a href="{% url 'add_bookmark' book.id %}" style="text-decoration: none; color: white; background-color: #28a745; padding: 10px 15px; border-radius: 5px; display: inline-block; margin-top: 10px;">Bookmark this Book</a>
                {% endif %}
            {% else %}
                <p style="margin-top: 20px;"><a href="{% url 'signin' %}">Sign in</a> to bookmark this book.</p>
            {% endif %}
            <div class="book-rating" style="margin-top: 20px;">
                <h5>Bibliosphere's Rating:</h5>
                {% if average_rating %}
                    <p>Rating: {{ average_rating|floatformat:2 }} / 5.0</p>
                {% else %}
                    <p>No one has rated this book, be the first to do it!</p>
                {% endif %}
            </div>
            <h5>Rating: {{ book.rating|default:"No rating" }}</h5>
            <h5>Liked by: {{ book.liked_percent|default:"No data on likes" }}%</h5>
            <h5>ISBN: {{ book.isbn|floatformat:"0"|cut:"." }}</h5>
            <h5>Awards:</h5>
                {% if book.awards %}
                    <ul id="short-awards" style="height: 100px; overflow: hidden;">
                        {% for award in book.awards %}
                            <li>{{ award }}</li>
                        {% endfor %}
                    </ul>
                    <a href="javascript:void(0);" id="read-more-awards-toggle" class="read-more-link">Read More</a>
                {% else %}
                    <p>No awards listed.</p>
                {% endif %}
        </div>
        <div class="col-md-9 ">
            <div class = "book-details">
                <h1>{{ book.title }}</h1>
                <h3><span>By:</span> {{ book.author }}</h3>
                <div class="additional-info">
                    <span>Publisher: {{ book.publisher|default:"Publisher not specified" }}</span>
                    <span>Genres: {% for genre in book.genres.all %}{{ genre.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</span>
                    <span>Series: {{ book.series|default:"No series information" }}</span>
                    <span>Characters: {{ book.characters|default:"No characters listed" }}</span>
                    <span>Setting: {{ book.setting|default:"Setting not specified" }}</span>
                    <span>No. Pages: {{ book.pages|default:"Page count not available" }}</span>
                </div>
            </div>
            <div class="book-description">
                <h3>Description</h3>
                <p id="short-description">{{ book.description|truncatewords:50 }}</p>
                <a href="javascript:void(0);" id="read-more-toggle" class="read-more-link">Read More</a>
                <div id="full-description" class="collapse">{{ book.description }}</div>
            </div>
            <div class="find-book">
                <h2>Find Your Book</h2>
                {% if links %}
                    <a href="{{ links }}" target="_blank">Find it in GoodReads</a>
                {% else %}
                    <p>No related link found.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="container rating-comments-container">
    <div class="row">
        <!-- Rating Column -->
        <div class="col-md-6">
            {% if user.is_authenticated %}
                <div class="book-rating-form">
                    <h3>Rate this Book</h3>
                    {% if user_rating %}
                        <p>You have rated this book: {{ user_rating.rating }}</p>
                    {% else %}
                        <form action="{% url 'add_rating' book.id %}" method="post">
                            {% csrf_token %}
                            <label for="rating">Your Rating (1-5):</label>
                            <input type="number" id="rating" name="rating" min="1" max="5" step="0.1" required>
                            <button type="submit" style="margin-top: 10px;">Submit Rating</button>
                        </form>
                    {% endif %}
                </div>
            {% else %}
                <p><a href="{% url 'signin' %}">Sign in</a> to rate this book.</p>
            {% endif %}
        </div>

        <!-- Comments Column -->
        <div class="col-md-6">
            <h3>Comments</h3>
            {% for comment in comments %}
                <div class="comment-container">
                    <strong>{{ comment.user.username }}</strong>
                    <p>{{ comment.content }}</p>
                    <small>Commented on {{ comment.created_at|date:"Y-m-d H:i" }}</small>
                </div>
            {% empty %}
                <p>No comments yet.</p>
            {% endfor %}

            <!-- Comment Form -->
            {% if user.is_authenticated %}
                <div class="comment-form">
                    <form action="{% url 'add_comment' book.id %}" method="post">
                        {% csrf_token %}
                        <textarea name="content" required placeholder="Add a comment..."></textarea>
                        <button type="submit">Add Comment</button>
                    </form>
                </div>
            {% else %}
                <p><a href="{% url 'signin' %}">Sign in</a> to add a comment.</p>
            {% endif %}
        </div>
    </div>
</div>


<div class="container recommended-books-container">
    <h2 style="text-align: center; margin-bottom: 20px;">You may also like</h2>
    <div class="book-grid">
        {% for book in recommended_books %}
            <div class="book-item">
                <!-- Use 'coverImg' field for image source -->
                <img class="book-img" src="{{ book.coverImg }}" alt="Cover image for {{ book.title }}" style="height: 250px;">
                <a href="{% url 'book_detail' book_id=book.id %}">
                    <h5>{{ book.title }}</h5>
                    <p>By: {{ book.author }}</p>
                </a>
            </div>
        {% endfor %}
    </div>
</div>



{% endblock %}

{% block custom_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var toggleBtn = document.getElementById('read-more-toggle');
        var fullDesc = document.getElementById('full-description');
        var shortDesc = document.getElementById('short-description');
        var isExpanded = false;  // State to track expansion

        toggleBtn.addEventListener('click', function(event) {
            if (isExpanded) {
                // Hide full description
                fullDesc.style.display = 'none';
                shortDesc.style.display = 'block';
                toggleBtn.textContent = "Read More";
                isExpanded = false;
            } else {
                // Show full description
                fullDesc.style.display = 'block';
                shortDesc.style.display = 'none';
                toggleBtn.textContent = "Read Less";
                isExpanded = true;
            }
        });

        var awardsToggleBtn = document.getElementById('read-more-awards-toggle');
        var shortAwards = document.getElementById('short-awards');
        var isAwardsExpanded = false;

        if (awardsToggleBtn) {
            awardsToggleBtn.addEventListener('click', function(event) {
                if (isAwardsExpanded) {
                    // Collapse awards list
                    shortAwards.style.height = '100px';
                    shortAwards.style.overflow = 'hidden';
                    awardsToggleBtn.textContent = "Read More";
                    isAwardsExpanded = false;
                } else {
                    // Expand awards list
                    shortAwards.style.height = 'auto';
                    shortAwards.style.overflow = 'visible';
                    awardsToggleBtn.textContent = "Read Less";
                    isAwardsExpanded = true;
                }
            });
        }
    });
</script>
{% endblock %}